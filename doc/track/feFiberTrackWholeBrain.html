<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of feFiberTrackWholeBrain</title>
  <meta name="keywords" content="feFiberTrackWholeBrain">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">track</a> &gt; feFiberTrackWholeBrain.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for track&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>feFiberTrackWholeBrain
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [fg outName] = feFiberTrackWholeBrain(dt6,trackOpts,outName,hem,save,fileFormat,wmSeedRegion) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> 
 function [fg outName] = mctFiberTrackWholeBrain([dt6],[trackOpts=dtiFiberTrackOpts],...
               outName=['FG_ ' hem],[hem='both'],[save=1]),[fileFormat='pdb'],[wmSeedRegion])
 
 This function will return a whole-brain group of fibers given some dt6
 file and some tracking parameters. User can specify which hemisphere to
 return with the 'hem' input argument. By default the whole-brain is
 tracked using a moderately thresholded FA mask of 0.35 as an ROI. Most
 default tracking parameters from dtiFiberTrackOpts are used if the user
 does not pass them in (see example usage). To change the number of fibers
 returned the user should edit the trackOpts by following the example
 below. Note that the default trackOpts return ~200K (depending on the
 data) and takes ~4-5min to run, thus, in this function - if the user does
 not pass in trackOpts - seedVoxelOffsets is set to 0, to return a
 reasonable number of pathways (~40k). If the user does pass in trackOpts
 we assume they know what they are asking for. 
 
 INPUTS:
       dt6        - File obtained from dtiInit
       trackOpts  - a structure containing the tracking params. Set with
                    dtiFiberTrackOpts. The default values are:
                        opts.stepSizeMm = 1; % mm
                        opts.faThresh = 0.20;
                        opts.lengthThreshMm = 20;
                        opts.angleThresh = 30;
                        opts.wPuncture = 0.2;
                        opts.whichAlgorithm = 1;
                        opts.whichInterp = 1;
                        opts.seedVoxelOffsets = [-0.25  0.25];
                        opts.offsetJitter = 0;
       outName    - Name of the output fibers as they will be saved.
       hem        - The hemisphere for which you want paths tracked.
                    Default is 'both'. 'left' or 'right' optional. 
       fileFormat - 'pdb' or 'mat' to save the output fibers.
       save       - 1 = save fibers, 0 = don't save the fibers (useful if
                    you just want to return the struct).
       wmSeedRegion     - A file of white matter coordinates. It will be used as ROI 
                    for tracking isntead of creating an ROI out of a FA-thresholded 
                    mask. The mask is assumed to ba at the resolution of
                    the dwi data and containing only 1's and 0's. Where 1
                    indicates white matter. (see feMakeWhiteMatterMask.m
                    for an example of how to create a WM mask.)

 OUTPUTS:
       fg         - structure containing the fibers in fg.fibers.
 
 WEB RESOURCES:
       mrvBrowseSVN('mctFiberTrackWholeBrain');
 
 EXAMPLE:
       trackOpts = dtiFiberTrackOpts('faThresh',.30,'seedVoxelOffsets',[0.25]);
       dt6       = 'dt6.mat';
       outName   = 'WholeBrainFG';
       hem       = 'both';
       fg = dtiFibersTrackWholeBrain(dt6,trackOpts,outName,hem,fileFormat,save)
 
 NOTES: Based on dtiFiberTrackWholeBrain

 Franco (C) Stanford VISTASOFT Team 2012</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="feTrack.html" class="code" title="function feTrack(dt6Dir,fibersFolder,lmax,nSeeds,wmMask)">feTrack</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [fg outName] = feFiberTrackWholeBrain(dt6,trackOpts,outName,hem,save,fileFormat,wmSeedRegion)</a>
0002 <span class="comment">%</span>
0003 <span class="comment">% function [fg outName] = mctFiberTrackWholeBrain([dt6],[trackOpts=dtiFiberTrackOpts],...</span>
0004 <span class="comment">%               outName=['FG_ ' hem],[hem='both'],[save=1]),[fileFormat='pdb'],[wmSeedRegion])</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% This function will return a whole-brain group of fibers given some dt6</span>
0007 <span class="comment">% file and some tracking parameters. User can specify which hemisphere to</span>
0008 <span class="comment">% return with the 'hem' input argument. By default the whole-brain is</span>
0009 <span class="comment">% tracked using a moderately thresholded FA mask of 0.35 as an ROI. Most</span>
0010 <span class="comment">% default tracking parameters from dtiFiberTrackOpts are used if the user</span>
0011 <span class="comment">% does not pass them in (see example usage). To change the number of fibers</span>
0012 <span class="comment">% returned the user should edit the trackOpts by following the example</span>
0013 <span class="comment">% below. Note that the default trackOpts return ~200K (depending on the</span>
0014 <span class="comment">% data) and takes ~4-5min to run, thus, in this function - if the user does</span>
0015 <span class="comment">% not pass in trackOpts - seedVoxelOffsets is set to 0, to return a</span>
0016 <span class="comment">% reasonable number of pathways (~40k). If the user does pass in trackOpts</span>
0017 <span class="comment">% we assume they know what they are asking for.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% INPUTS:</span>
0020 <span class="comment">%       dt6        - File obtained from dtiInit</span>
0021 <span class="comment">%       trackOpts  - a structure containing the tracking params. Set with</span>
0022 <span class="comment">%                    dtiFiberTrackOpts. The default values are:</span>
0023 <span class="comment">%                        opts.stepSizeMm = 1; % mm</span>
0024 <span class="comment">%                        opts.faThresh = 0.20;</span>
0025 <span class="comment">%                        opts.lengthThreshMm = 20;</span>
0026 <span class="comment">%                        opts.angleThresh = 30;</span>
0027 <span class="comment">%                        opts.wPuncture = 0.2;</span>
0028 <span class="comment">%                        opts.whichAlgorithm = 1;</span>
0029 <span class="comment">%                        opts.whichInterp = 1;</span>
0030 <span class="comment">%                        opts.seedVoxelOffsets = [-0.25  0.25];</span>
0031 <span class="comment">%                        opts.offsetJitter = 0;</span>
0032 <span class="comment">%       outName    - Name of the output fibers as they will be saved.</span>
0033 <span class="comment">%       hem        - The hemisphere for which you want paths tracked.</span>
0034 <span class="comment">%                    Default is 'both'. 'left' or 'right' optional.</span>
0035 <span class="comment">%       fileFormat - 'pdb' or 'mat' to save the output fibers.</span>
0036 <span class="comment">%       save       - 1 = save fibers, 0 = don't save the fibers (useful if</span>
0037 <span class="comment">%                    you just want to return the struct).</span>
0038 <span class="comment">%       wmSeedRegion     - A file of white matter coordinates. It will be used as ROI</span>
0039 <span class="comment">%                    for tracking isntead of creating an ROI out of a FA-thresholded</span>
0040 <span class="comment">%                    mask. The mask is assumed to ba at the resolution of</span>
0041 <span class="comment">%                    the dwi data and containing only 1's and 0's. Where 1</span>
0042 <span class="comment">%                    indicates white matter. (see feMakeWhiteMatterMask.m</span>
0043 <span class="comment">%                    for an example of how to create a WM mask.)</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% OUTPUTS:</span>
0046 <span class="comment">%       fg         - structure containing the fibers in fg.fibers.</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% WEB RESOURCES:</span>
0049 <span class="comment">%       mrvBrowseSVN('mctFiberTrackWholeBrain');</span>
0050 <span class="comment">%</span>
0051 <span class="comment">% EXAMPLE:</span>
0052 <span class="comment">%       trackOpts = dtiFiberTrackOpts('faThresh',.30,'seedVoxelOffsets',[0.25]);</span>
0053 <span class="comment">%       dt6       = 'dt6.mat';</span>
0054 <span class="comment">%       outName   = 'WholeBrainFG';</span>
0055 <span class="comment">%       hem       = 'both';</span>
0056 <span class="comment">%       fg = dtiFibersTrackWholeBrain(dt6,trackOpts,outName,hem,fileFormat,save)</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% NOTES: Based on dtiFiberTrackWholeBrain</span>
0059 <span class="comment">%</span>
0060 <span class="comment">% Franco (C) Stanford VISTASOFT Team 2012</span>
0061 
0062 <span class="comment">% Check inputs</span>
0063 fg = [];
0064 <span class="keyword">if</span> notDefined(<span class="string">'dt6'</span>)
0065     dt6 = mrvSelectFile(<span class="string">'r'</span>,<span class="string">'*.mat'</span>,<span class="string">'Please select a dt6.mat file.'</span>);
0066 <span class="keyword">end</span>
0067 
0068 <span class="comment">% If the user does not pass in trackOpts we set them to default values</span>
0069 <span class="comment">% (except for seedVoxelOffsets, which is set to 0 to return a</span>
0070 <span class="comment">% reasonable number of pathways (~40k)).</span>
0071 <span class="keyword">if</span> notDefined(<span class="string">'trackOpts'</span>);  trackOpts  = dtiFiberTrackOpts(<span class="string">'seedVoxelOffsets'</span>, 0) ; <span class="keyword">end</span>
0072 <span class="keyword">if</span> notDefined(<span class="string">'hem'</span>);        hem        = <span class="string">'both'</span>; <span class="keyword">end</span>
0073 <span class="keyword">if</span> notDefined(<span class="string">'fileFormat'</span>); fileFormat = <span class="string">'pdb'</span>; <span class="keyword">end</span>
0074 <span class="keyword">if</span> notDefined(<span class="string">'outName'</span>);    outName    = [<span class="string">'fe_whole_brain_'</span> hem <span class="string">'Hem'</span>]; <span class="keyword">end</span>
0075 <span class="keyword">if</span> notDefined(<span class="string">'save'</span>);       save       = 1; <span class="keyword">end</span>
0076 
0077 <span class="comment">% We don't want the full path in the fiber.name field. We will rebuild</span>
0078 <span class="comment">% later in the case that the user want's the fibers saved.</span>
0079 [p f] = fileparts(outName); outName = f; 
0080 
0081 <span class="comment">%% Switch on possible inputs for hem and fileFormat</span>
0082 <span class="keyword">switch</span> lower(hem)
0083     <span class="keyword">case</span> {<span class="string">'left'</span> ,<span class="string">'l'</span>}; hem = 1;
0084     <span class="keyword">case</span> {<span class="string">'right'</span>,<span class="string">'r'</span>}; hem = 2;
0085     <span class="keyword">case</span> {<span class="string">'both'</span> ,<span class="string">'b'</span>}; hem = 0;
0086 <span class="keyword">end</span>
0087 
0088 <span class="keyword">switch</span> lower(fileFormat)
0089     <span class="keyword">case</span> {<span class="string">'pdb'</span>,<span class="string">'.pdb'</span>,<span class="string">'p'</span>}; fileFormat = 1;
0090     <span class="keyword">case</span> {<span class="string">'mat'</span>,<span class="string">'.mat'</span>,<span class="string">'m'</span>}; fileFormat = 0;
0091 <span class="keyword">end</span>            
0092 
0093 <span class="comment">% Load dt6</span>
0094 <span class="keyword">if</span>     ischar(dt6), dt = dtiLoadDt6(dt6);
0095 <span class="keyword">elseif</span> iscell(dt6), dt = dt6;
0096 <span class="keyword">else</span>                keyboard;
0097 <span class="keyword">end</span>
0098   
0099 <span class="comment">% If a white-matter mask was not passed in we guess a reasonable</span>
0100 <span class="comment">% white-matter mas using FA thresholding. This is not quite correct because</span>
0101 <span class="comment">% reagions of corssing fibers might not pass the criteria and enter as seed</span>
0102 <span class="comment">% for tracking. Btu this guess has worked reasonably well in the past,</span>
0103 <span class="comment">% because the mask here is only a seed mask and the actual FA thresholding</span>
0104 <span class="comment">% is done inside the c-code of dtiFiberTracker.cxx</span>
0105 <span class="keyword">if</span> notDefined(<span class="string">'wmSeedRegion'</span>)
0106     <span class="comment">% Compute FA and create a brain mask ROI</span>
0107     <span class="comment">%</span>
0108     <span class="comment">% Compute the FA and normalize</span>
0109     fa = dtiComputeFA(dt.dt6);
0110     fa( fa &gt; 1 ) = 1;
0111     fa( fa &lt; 0 ) = 0;
0112     
0113     <span class="comment">% Using a reasonable FA as a threshold - if you use opts.faThresh (.15) for</span>
0114     <span class="comment">% this purpose you get ~1 million paths back, which takes way too long to</span>
0115     <span class="comment">% track. Instead we only use voxels with an FA of at least .35 as seed</span>
0116     <span class="comment">% points. This gives us ~200-400K paths with default trackOpts.</span>
0117     faThresh = 0.35;
0118     mask      = fa &gt;= faThresh;
0119 <span class="keyword">else</span>
0120     <span class="comment">% The white matter mask is assumed to have only 0's and 1's inside.</span>
0121     <span class="comment">% Where 1's indicate white-matter</span>
0122    ni = niftiRead( wmSeedRegion );
0123    mask = ni.data; 
0124    clear ni
0125 <span class="keyword">end</span>
0126 
0127 <span class="comment">% Find the voxels that we will use as sed for tracking</span>
0128 [x,y,z]  = ind2sub(size(mask), find(mask));
0129 
0130 <span class="comment">% Create a new whole-brain ROI from the mask</span>
0131 roiAll        = dtiNewRoi(<span class="string">'all'</span>);
0132 roiAll.coords = mrAnatXformCoords(dt.xformToAcpc, [x,y,z]);
0133 
0134 <span class="keyword">if</span> ~notDefined(<span class="string">'wmSeedRegion'</span>)
0135     <span class="comment">% Smooth the ROI and fill holes</span>
0136     roiAll = dtiRoiClean(roiAll,3,{<span class="string">'fillHoles'</span>});
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">% Generate ROI coords for each case</span>
0140 <span class="comment">%</span>
0141 <span class="comment">% Whole brain (hem = 'both')</span>
0142 <span class="keyword">if</span> hem == 0; disp(<span class="string">'Tracking Whole-Brain Fibers ...'</span>);
0143     coords = roiAll.coords; 
0144 <span class="keyword">end</span>
0145 
0146 <span class="comment">% Left hemisphere (hem = 'left')</span>
0147 <span class="keyword">if</span> hem == 1; disp(<span class="string">'Tracking Left Hemisphere Fibers ...'</span>);
0148     roiLeft = dtiRoiClip(roiAll, [1 80]);
0149     coords  = roiLeft.coords;
0150 <span class="keyword">end</span>
0151 
0152 <span class="comment">% Left hemisphere (hem = 'right')</span>
0153 <span class="keyword">if</span> hem == 2; disp(<span class="string">'Tracking Right Hemisphere Fibers ...'</span>);
0154     roiRight = dtiRoiClip(roiAll, [-80 -1]);
0155     coords   = roiRight.coords;
0156 <span class="keyword">end</span>
0157 
0158 <span class="keyword">if</span> ~(exist(fullfile(p,[outName,<span class="string">'.mat'</span>]),<span class="string">'file'</span>) == 2)
0159   <span class="comment">% Track and clean the fibers</span>
0160   <span class="comment">% fg = dtiFiberTrack2(dt.dt6, coords, 1, 0, dt.mmPerVoxel, dt.xformToAcpc, outName, trackOpts);</span>
0161   
0162   <span class="comment">% Track and clean the fibers - using STT</span>
0163   fg = dtiFiberTrack(dt.dt6, coords, dt.mmPerVoxel, dt.xformToAcpc, outName, trackOpts);
0164 
0165   <span class="comment">% Clean the fibers. This will ensure there is only one point that crosses</span>
0166   <span class="comment">% the midline.</span>
0167   <span class="comment">% fg = dtiCleanFibers(fg); % I commented this out because the cleaning</span>
0168   <span class="comment">% resamples the fibers at 1mm.</span>
0169   
0170   <span class="comment">% Save out the fibers using the selected fileFormat (mat or pdb)</span>
0171   <span class="keyword">if</span> save == 1
0172     <span class="comment">% Rebuild outName in the case that the user passed in a full path</span>
0173     <span class="comment">% originally.</span>
0174     outName = fullfile(p,outName);
0175     <span class="keyword">if</span>(fileFormat == 0); dtiWriteFiberGroup(fg, outName); <span class="keyword">end</span>
0176     <span class="keyword">if</span>(fileFormat == 1); mtrExportFibers(fg, outName);    <span class="keyword">end</span>
0177     fprintf(<span class="string">'Saved %s. \n'</span>, outName);
0178   <span class="keyword">end</span>
0179 <span class="keyword">else</span>
0180   outName = fullfile(p,outName);
0181   fprintf(<span class="string">'\nFound tracking file %s. Not tracking.\n'</span>, outName);
0182 <span class="keyword">end</span>
0183   
0184 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Tue 01-Jul-2014 11:25:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>