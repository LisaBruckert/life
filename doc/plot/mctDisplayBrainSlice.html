<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mctDisplayBrainSlice</title>
  <meta name="keywords" content="mctDisplayBrainSlice">
  <meta name="description" content="Add a slice from a nifti image to a 3D plot">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">plot</a> &gt; mctDisplayBrainSlice.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for plot&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>mctDisplayBrainSlice
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Add a slice from a nifti image to a 3D plot</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function h = mctDisplayBrainSlice(nifti, slice, cmap, rescale,alpha) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Add a slice from a nifti image to a 3D plot

 h = mctDisplayBrainSlice(nifti, slice, [cmap], [rescale],alpha)

 Inputs:

 nifti   = A 3D nifti image. It is ok if the image has translation
           information in the header, however there may be problems if
           there are rotations saved into the header. Typically we do not
           save rotations into the header so everything should be fine.

 slice   = Designate which slice in acpc (millimeter) coordinates should
           be added to the plot. slice should be a 1x3 vector where each
           coordinate is either a 0 or nan except the coordinate of the
           slice to be rendered. For example to render the coronal slice 5
           mm anterior to the anterior commissure: slice = [5 0 0]. For an
           axial slice 10mm below the acpc plane: slice = [0 0 -10]. For a
           sagittal slice 25mm to the left of the mid-sagittal plane:
           slice = [-25 0 0]

 cmap    = Define a colormap for the values in the image.  The defualt is
           cmap = 'gray'; Other options: cmap = 'jet'; cmap = 'hot'; etc.

 rescale = If the image is being added to an existing axis the default is
           to rescale the axis so the full image can be seen 
           [rescale = 1]. To preserve the current axis properties: 
           rescale = 0

 Output:

 h       = Handle for the object in the figure.  You can remove the slice
           from the figure window with: delete(h);

 Example:

 h = mctDisplayBrainSlice(nifti, [-20 0 0])

 (C) 2012 Stanford VISTA team.

 Modified from Jason's code</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function h = mctDisplayBrainSlice(nifti, slice, cmap, rescale,alpha)</a>
0002 <span class="comment">% Add a slice from a nifti image to a 3D plot</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% h = mctDisplayBrainSlice(nifti, slice, [cmap], [rescale],alpha)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Inputs:</span>
0007 <span class="comment">%</span>
0008 <span class="comment">% nifti   = A 3D nifti image. It is ok if the image has translation</span>
0009 <span class="comment">%           information in the header, however there may be problems if</span>
0010 <span class="comment">%           there are rotations saved into the header. Typically we do not</span>
0011 <span class="comment">%           save rotations into the header so everything should be fine.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% slice   = Designate which slice in acpc (millimeter) coordinates should</span>
0014 <span class="comment">%           be added to the plot. slice should be a 1x3 vector where each</span>
0015 <span class="comment">%           coordinate is either a 0 or nan except the coordinate of the</span>
0016 <span class="comment">%           slice to be rendered. For example to render the coronal slice 5</span>
0017 <span class="comment">%           mm anterior to the anterior commissure: slice = [5 0 0]. For an</span>
0018 <span class="comment">%           axial slice 10mm below the acpc plane: slice = [0 0 -10]. For a</span>
0019 <span class="comment">%           sagittal slice 25mm to the left of the mid-sagittal plane:</span>
0020 <span class="comment">%           slice = [-25 0 0]</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% cmap    = Define a colormap for the values in the image.  The defualt is</span>
0023 <span class="comment">%           cmap = 'gray'; Other options: cmap = 'jet'; cmap = 'hot'; etc.</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% rescale = If the image is being added to an existing axis the default is</span>
0026 <span class="comment">%           to rescale the axis so the full image can be seen</span>
0027 <span class="comment">%           [rescale = 1]. To preserve the current axis properties:</span>
0028 <span class="comment">%           rescale = 0</span>
0029 <span class="comment">%</span>
0030 <span class="comment">% Output:</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% h       = Handle for the object in the figure.  You can remove the slice</span>
0033 <span class="comment">%           from the figure window with: delete(h);</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% Example:</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% h = mctDisplayBrainSlice(nifti, [-20 0 0])</span>
0038 <span class="comment">%</span>
0039 <span class="comment">% (C) 2012 Stanford VISTA team.</span>
0040 <span class="comment">%</span>
0041 <span class="comment">% Modified from Jason's code</span>
0042 
0043 <span class="comment">%% Check arguments</span>
0044 <span class="keyword">if</span> ~exist(<span class="string">'cmap'</span>,<span class="string">'var'</span>) || isempty(cmap)
0045     cmap = gray(256);
0046 <span class="keyword">end</span>
0047 <span class="keyword">if</span> ~exist(<span class="string">'rescale'</span>,<span class="string">'var'</span>) || isempty(rescale)
0048     rescale = 1;
0049 <span class="keyword">end</span>
0050 <span class="comment">% Make sure only one plane was designated for plotting</span>
0051 plane = ~isnan(slice);
0052 <span class="keyword">if</span> sum(plane) &gt; 1
0053     plane = slice ~= 0;
0054 <span class="keyword">end</span>
0055 <span class="keyword">if</span> sum(plane) &gt; 1
0056     error(<span class="string">'Only one slice can be plotted. Other values should be nan or 0'</span>)
0057 <span class="keyword">end</span>
0058 <span class="comment">% Replace nans with zeros</span>
0059 slice = slice .* plane;
0060 <span class="comment">% Make sure slice is a row vector</span>
0061 <span class="keyword">if</span> size(slice,2) ~= 3
0062     slice = slice';
0063 <span class="keyword">end</span>
0064 
0065 <span class="keyword">if</span> notDefined(<span class="string">'alpha'</span>), alpha=1;<span class="keyword">end</span>
0066 
0067 <span class="comment">%% Format the image with propper transforms etc.</span>
0068 <span class="comment">% The variable slice is given in acpc coordinates.  Transform acpc to image</span>
0069 <span class="comment">% coordinates</span>
0070 imgXform = nifti.qto_ijk;
0071 ImCoords = floor(imgXform * [slice 1]');
0072 imIndx = ImCoords(find(slice));
0073 
0074 <span class="comment">% Pull the desired slice out of the 3d image volume</span>
0075 <span class="keyword">if</span> find(plane) == 1
0076     image = squeeze(nifti.data(imIndx,:,:));
0077     <span class="comment">% Define the minimum and maximum coordinates of the image in each</span>
0078     <span class="comment">% dimension in acpc mm space.</span>
0079     min_x = slice(1); max_x = min_x;
0080     [y z] = size(image);
0081     max_corner = inv(imgXform) * [imIndx y z 1]';
0082     max_y = max_corner(2); max_z = max_corner(3);
0083     min_corner = inv(imgXform) * [imIndx 0 0 1]';
0084     min_y = min_corner(2); min_z = min_corner(3);
0085 <span class="keyword">elseif</span> find(plane) == 2
0086     image = squeeze(nifti.data(:,imIndx,:));
0087     <span class="comment">% Define the minimum and maximum coordinates of the image in each</span>
0088     <span class="comment">% dimension in acpc mm space.</span>
0089     min_y = slice(2); max_y = min_y;
0090     [x z] = size(image);
0091     max_corner = inv(imgXform) * [x imIndx z 1]';
0092     max_x = max_corner(1); max_z = max_corner(3);
0093     min_corner = inv(imgXform) * [0 imIndx 0 1]';
0094     min_x = min_corner(1); min_z = min_corner(3);
0095 <span class="keyword">else</span>
0096     image = squeeze(nifti.data(:,:,imIndx));
0097     <span class="comment">% Define the minimum and maximum coordinates of the image in each</span>
0098     <span class="comment">% dimension in acpc mm space.</span>
0099     min_z = slice(3); max_z = min_z;
0100     [x y] = size(image);
0101     max_corner = inv(imgXform) * [x y imIndx 1]';
0102     max_x = max_corner(1); max_y = max_corner(2);
0103     min_corner = inv(imgXform) * [0 0 imIndx 1]';
0104     min_x = min_corner(1); min_y = min_corner(2);
0105 <span class="keyword">end</span>
0106 
0107 <span class="comment">% Resample the image to 1mm resolution. The necessary scale factor is</span>
0108 <span class="comment">% stored in the image xform.</span>
0109 scale = diag(nifti.qto_xyz); scale = scale(1:3);
0110 <span class="comment">% The new dimensions will be the old dimensions multiplied by the scale</span>
0111 <span class="comment">% factors for the plane</span>
0112 oldDim = size(image);
0113 newDim = oldDim .* scale(find(plane == 0))';
0114 <span class="comment">% Resize the image</span>
0115 image = double(imresize(image,newDim));
0116 
0117 <span class="comment">% Scale and clip the image values so that the lowest 25% of the values are</span>
0118 <span class="comment">% zeroed, the top 5% are maxed and the range is 0 to 255</span>
0119 image = uint8(mrAnatHistogramClip(image,.25,.95,1).* 255);
0120 
0121 <span class="comment">% Convert the scaler image to an RGB image based on the chosen colormap</span>
0122 colorimg = ind2rgb(image,cmap);
0123 
0124 <span class="comment">%% Plot the image</span>
0125 <span class="comment">% The call to surface will be slightly different depending on whether it is</span>
0126 <span class="comment">% an axial, sagittal or coronal image.</span>
0127 <span class="keyword">if</span> find(plane) == 1
0128     <span class="comment">% Add the image to the current 3D plot</span>
0129     z_dims = [min_z max_z; min_z max_z];
0130     h = surf([min_x max_x],[min_y max_y],z_dims,<span class="keyword">...</span>
0131         colorimg,<span class="string">'facecolor'</span>,<span class="string">'texture'</span>,<span class="string">'faceAlpha'</span>,alpha);
0132 <span class="keyword">elseif</span> find(plane) == 2
0133     <span class="comment">% The image dimensions must be permuted to match what is expected in</span>
0134     <span class="comment">% surf</span>
0135     colorimg=permute(colorimg,[2 1 3]);
0136     <span class="comment">% Add the image to the current 3D plot</span>
0137     z_dims = [min_z min_z;   max_z max_z];
0138     h = surf([min_x max_x],[min_y max_y],z_dims,<span class="keyword">...</span>
0139         colorimg,<span class="string">'facecolor'</span>,<span class="string">'texture'</span>,<span class="string">'FaceAlpha'</span>,alpha);
0140 <span class="keyword">elseif</span> find(plane) == 3
0141     <span class="comment">% The image dimensions must be permuted to match what is expected in</span>
0142     <span class="comment">% surf</span>
0143     colorimg=permute(colorimg,[2 1 3]);
0144     <span class="comment">% Add the image to the current 3D plot</span>
0145     h =surf([min_x max_x],[min_y max_y],repmat(min_z, [2 2]),<span class="keyword">...</span>
0146         colorimg,<span class="string">'facecolor'</span>,<span class="string">'texture'</span>,<span class="string">'FaceAlpha'</span>,alpha);
0147 <span class="keyword">end</span>
0148 
0149 <span class="comment">% Rescale the axis to fit the image</span>
0150 <span class="keyword">if</span> rescale == 1
0151     <span class="comment">% Old axis values</span>
0152     ax = axis;
0153     <span class="comment">% New axis scaling</span>
0154     ax2 = [min_x max_x min_y max_y min_z max_z];
0155     <span class="comment">% Only change the dimensions that are needed to see the full image</span>
0156     <span class="keyword">if</span> find(plane) == 1
0157         ax2(1:2) = ax(1:2);
0158     <span class="keyword">elseif</span> find(plane) == 2
0159         ax2(3:4) = ax(3:4);
0160     <span class="keyword">elseif</span> find(plane) == 3;
0161         ax2(5:6) = ax(3:4);
0162     <span class="keyword">end</span>
0163     <span class="comment">% Rescale axis</span>
0164     axis(ax2);
0165 <span class="keyword">end</span>
0166 
0167 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Tue 01-Jul-2014 11:25:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>