<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of fefgGet</title>
  <meta name="keywords" content="fefgGet">
  <meta name="description" content="Get values from a fiber group structure">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">utility</a> &gt; fefgGet.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for utility&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>fefgGet
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Get values from a fiber group structure</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function val = fefgGet(fg,param,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Get values from a fiber group structure

  val = fefgGet(fg,param,varargin)

 Copyright (2013-2014), Franco Pestilli, Stanford University, pestillifranco@gmail.com.

------------
 Returns the length of each fiber in the fiber group
 flen = fefgGet(fg,'length')
------------
 Compute the Westin shape parameters (linearity and planarity)
 for all the fibers in the fiber group.
 Requires a dt structure.
 westin = fefgGet(fg,'westinshape',dt)
 westin = fefgGet(fg,'westinshape',eigenvals)
 westin = fefgGet(fg,'westinshape',dtFileName)
-------------
 Compute eigenvalues for the fibers in a fiber group.
 It requires a dt structure.
 eigenvals = fefgGet(fg,'eigenvals',dt)
 eigenvals = fefgGet(fg,'eigenvals',dtFileName)
-------------
 Compute the 6 parameters for the tensors at each node in each fiber.
 It requires a dt structure.
 dt6 = fefgGet(fg,'eigenvals',dt)
 dt6 = fefgGet(fg,'eigenvals',dtFileName)
-------------
 Compute the radial and axial ADC for all the fibers in the fiber group.
 Requires a dt structure.
 adc = fefgGet(fg,'adc',dt)
 adc = fefgGet(fg,'adc',eigenvals)
 adc = fefgGet(fg,'adc',dtFileName)
-------------
 Compute the FA for all the fibers in the fiber group.
 Requires a dt structure.
 fa = fefgGet(fg,'fa',dt)
 fa = fefgGet(fg,'fa',eigenvals)
 fa = fefgGet(fg,'fa',dtFileName)
-------------
 Compute the Mean Diffusivity for all the fibers in the fiber group.
 Requires a dt structure.
 md = fefgGet(fg,'md',dt)
 md = fefgGet(fg,'md',eigenvals)
 md = fefgGet(fg,'md',dtFileName)
-------------
 Compute the Radial Diffusivity for all the fibers in the fiber group.
 Requires a dt structure.
 rd = fefgGet(fg,'rd',dt)
 rd = fefgGet(fg,'rd',eigenvals)
 rd = fefgGet(fg,'rd',dtFileName)
-------------
 Compute the Axial Diffusivity for all the fibers in the fiber group.
 Requires a dt structure.
 ad = fefgGet(fg,'ad',dt)
 ad = fefgGet(fg,'ad',eigenvals)
 ad = fefgGet(fg,'ad',dtFileName)
-------------
 Compute the radial and axial ADC for all the fibers in the fiber group.
 Requires a dt structure.
 adc = fefgGet(fg,'adc',dt)
 adc = fefgGet(fg,'adc',eigenvals)
 adc = fefgGet(fg,'adc',dtFileName)
-------------

 Parameters
 General
    'name'
    'type'
    'colorrgb'
    'thickness'
    'visible'

 Fiber related
    'nfibers'- Number of fibers in this group
    'nodes per fiber'  - Number of nodes per fiber.
    'fibers' - Fiber coordinates
    'fibernames'
    'fiberindex'
 Compute the Mean Diffusivity for all the fibers in the fiber group.
 Requires a dt structure.
 fa = fefgGet(fg,'fa',dt)
 fa = fefgGet(fg,'fa',eigenvals)

 ROI and image coord related
    'unique image coords'
    'nodes to imagecoords' -
    'voxel2fiber node pairs' - For each roi coord, an Nx2 matrix of
        (fiber number,node number)
    'nodes in voxels' - Nodes inside the voxels of roi coords
    'voxels in fg'  - Cell array of the roiCoords touched by each fiber
    'voxels2fibermatrix' - Binary matrix (voxels by fibers).  1s when a
        fiber is in a voxel of the roiCoords (which are, sadly, implicit).

 Tensor and tractography related
      'tensors'     - Tensors for each node


 See also: fgCreate; fgSet

 Copyright (2013-2014), Franco Pestilli, Stanford University, pestillifranco@gmail.com.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>	Get values from a fiber group structure</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>	Get values from a fiber group structure</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function val = fefgGet(fg,param,varargin)</a>
0002 <span class="comment">% Get values from a fiber group structure</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  val = fefgGet(fg,param,varargin)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% Copyright (2013-2014), Franco Pestilli, Stanford University, pestillifranco@gmail.com.</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%------------</span>
0009 <span class="comment">% Returns the length of each fiber in the fiber group</span>
0010 <span class="comment">% flen = fefgGet(fg,'length')</span>
0011 <span class="comment">%------------</span>
0012 <span class="comment">% Compute the Westin shape parameters (linearity and planarity)</span>
0013 <span class="comment">% for all the fibers in the fiber group.</span>
0014 <span class="comment">% Requires a dt structure.</span>
0015 <span class="comment">% westin = fefgGet(fg,'westinshape',dt)</span>
0016 <span class="comment">% westin = fefgGet(fg,'westinshape',eigenvals)</span>
0017 <span class="comment">% westin = fefgGet(fg,'westinshape',dtFileName)</span>
0018 <span class="comment">%-------------</span>
0019 <span class="comment">% Compute eigenvalues for the fibers in a fiber group.</span>
0020 <span class="comment">% It requires a dt structure.</span>
0021 <span class="comment">% eigenvals = fefgGet(fg,'eigenvals',dt)</span>
0022 <span class="comment">% eigenvals = fefgGet(fg,'eigenvals',dtFileName)</span>
0023 <span class="comment">%-------------</span>
0024 <span class="comment">% Compute the 6 parameters for the tensors at each node in each fiber.</span>
0025 <span class="comment">% It requires a dt structure.</span>
0026 <span class="comment">% dt6 = fefgGet(fg,'eigenvals',dt)</span>
0027 <span class="comment">% dt6 = fefgGet(fg,'eigenvals',dtFileName)</span>
0028 <span class="comment">%-------------</span>
0029 <span class="comment">% Compute the radial and axial ADC for all the fibers in the fiber group.</span>
0030 <span class="comment">% Requires a dt structure.</span>
0031 <span class="comment">% adc = fefgGet(fg,'adc',dt)</span>
0032 <span class="comment">% adc = fefgGet(fg,'adc',eigenvals)</span>
0033 <span class="comment">% adc = fefgGet(fg,'adc',dtFileName)</span>
0034 <span class="comment">%-------------</span>
0035 <span class="comment">% Compute the FA for all the fibers in the fiber group.</span>
0036 <span class="comment">% Requires a dt structure.</span>
0037 <span class="comment">% fa = fefgGet(fg,'fa',dt)</span>
0038 <span class="comment">% fa = fefgGet(fg,'fa',eigenvals)</span>
0039 <span class="comment">% fa = fefgGet(fg,'fa',dtFileName)</span>
0040 <span class="comment">%-------------</span>
0041 <span class="comment">% Compute the Mean Diffusivity for all the fibers in the fiber group.</span>
0042 <span class="comment">% Requires a dt structure.</span>
0043 <span class="comment">% md = fefgGet(fg,'md',dt)</span>
0044 <span class="comment">% md = fefgGet(fg,'md',eigenvals)</span>
0045 <span class="comment">% md = fefgGet(fg,'md',dtFileName)</span>
0046 <span class="comment">%-------------</span>
0047 <span class="comment">% Compute the Radial Diffusivity for all the fibers in the fiber group.</span>
0048 <span class="comment">% Requires a dt structure.</span>
0049 <span class="comment">% rd = fefgGet(fg,'rd',dt)</span>
0050 <span class="comment">% rd = fefgGet(fg,'rd',eigenvals)</span>
0051 <span class="comment">% rd = fefgGet(fg,'rd',dtFileName)</span>
0052 <span class="comment">%-------------</span>
0053 <span class="comment">% Compute the Axial Diffusivity for all the fibers in the fiber group.</span>
0054 <span class="comment">% Requires a dt structure.</span>
0055 <span class="comment">% ad = fefgGet(fg,'ad',dt)</span>
0056 <span class="comment">% ad = fefgGet(fg,'ad',eigenvals)</span>
0057 <span class="comment">% ad = fefgGet(fg,'ad',dtFileName)</span>
0058 <span class="comment">%-------------</span>
0059 <span class="comment">% Compute the radial and axial ADC for all the fibers in the fiber group.</span>
0060 <span class="comment">% Requires a dt structure.</span>
0061 <span class="comment">% adc = fefgGet(fg,'adc',dt)</span>
0062 <span class="comment">% adc = fefgGet(fg,'adc',eigenvals)</span>
0063 <span class="comment">% adc = fefgGet(fg,'adc',dtFileName)</span>
0064 <span class="comment">%-------------</span>
0065 <span class="comment">%</span>
0066 <span class="comment">% Parameters</span>
0067 <span class="comment">% General</span>
0068 <span class="comment">%    'name'</span>
0069 <span class="comment">%    'type'</span>
0070 <span class="comment">%    'colorrgb'</span>
0071 <span class="comment">%    'thickness'</span>
0072 <span class="comment">%    'visible'</span>
0073 <span class="comment">%</span>
0074 <span class="comment">% Fiber related</span>
0075 <span class="comment">%    'nfibers'- Number of fibers in this group</span>
0076 <span class="comment">%    'nodes per fiber'  - Number of nodes per fiber.</span>
0077 <span class="comment">%    'fibers' - Fiber coordinates</span>
0078 <span class="comment">%    'fibernames'</span>
0079 <span class="comment">%    'fiberindex'</span>
0080 <span class="comment">% Compute the Mean Diffusivity for all the fibers in the fiber group.</span>
0081 <span class="comment">% Requires a dt structure.</span>
0082 <span class="comment">% fa = fefgGet(fg,'fa',dt)</span>
0083 <span class="comment">% fa = fefgGet(fg,'fa',eigenvals)</span>
0084 <span class="comment">%</span>
0085 <span class="comment">% ROI and image coord related</span>
0086 <span class="comment">%    'unique image coords'</span>
0087 <span class="comment">%    'nodes to imagecoords' -</span>
0088 <span class="comment">%    'voxel2fiber node pairs' - For each roi coord, an Nx2 matrix of</span>
0089 <span class="comment">%        (fiber number,node number)</span>
0090 <span class="comment">%    'nodes in voxels' - Nodes inside the voxels of roi coords</span>
0091 <span class="comment">%    'voxels in fg'  - Cell array of the roiCoords touched by each fiber</span>
0092 <span class="comment">%    'voxels2fibermatrix' - Binary matrix (voxels by fibers).  1s when a</span>
0093 <span class="comment">%        fiber is in a voxel of the roiCoords (which are, sadly, implicit).</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% Tensor and tractography related</span>
0096 <span class="comment">%      'tensors'     - Tensors for each node</span>
0097 <span class="comment">%</span>
0098 <span class="comment">%</span>
0099 <span class="comment">% See also: fgCreate; fgSet</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% Copyright (2013-2014), Franco Pestilli, Stanford University, pestillifranco@gmail.com.</span>
0102 val = [];
0103 
0104 <span class="keyword">switch</span> strrep(lower(param),<span class="string">' '</span>,<span class="string">''</span>)
0105   
0106   <span class="comment">% Basic fiber parameters</span>
0107   <span class="keyword">case</span> <span class="string">'name'</span>
0108     val = fg.name;
0109   <span class="keyword">case</span> <span class="string">'type'</span>  <span class="comment">% Should always be fibergroup</span>
0110     val = fg.type;
0111     
0112     <span class="comment">% Fiber visualization settings.</span>
0113   <span class="keyword">case</span> <span class="string">'colorrgb'</span>
0114     val = fg.colorRgb;
0115   <span class="keyword">case</span> <span class="string">'thickness'</span>
0116     val = fg.thickness;
0117   <span class="keyword">case</span> <span class="string">'visible'</span>
0118     val = fg.visible;
0119     
0120     <span class="comment">% Simple fiber properties --</span>
0121   <span class="keyword">case</span> {<span class="string">'fibers'</span>}
0122     <span class="comment">% val = fefgGet(fg,'fibers',fList);</span>
0123     <span class="comment">%</span>
0124     <span class="comment">% Returns a 3xN matrix of fiber coordinates corresponding to the</span>
0125     <span class="comment">% fibers specified in the integer vector, fList.  This differs from</span>
0126     <span class="comment">% the dtiH (mrDiffusion) representation, where fiber coordinates</span>
0127     <span class="comment">% are stored as a set of cell arrays for each fiber.</span>
0128     <span class="keyword">if</span> ~isempty(varargin)
0129       list = varargin{1};
0130       val = cell(length(list),1);
0131       <span class="keyword">for</span> ii=1:length(list)
0132         val{ii} = fg.fibers{ii};
0133       <span class="keyword">end</span>
0134     <span class="keyword">else</span>
0135       val = fg.fibers;
0136     <span class="keyword">end</span>
0137   <span class="keyword">case</span> <span class="string">'fibernames'</span>
0138     val = fg.fiberNames;
0139   <span class="keyword">case</span> <span class="string">'fiberindex'</span>
0140     val = fg.fiberIndex;
0141   <span class="keyword">case</span> <span class="string">'nfibers'</span>
0142     val = length(fg.fibers);
0143   <span class="keyword">case</span> {<span class="string">'nodesperfiber'</span>,<span class="string">'nsamplesperfiber'</span>,<span class="string">'nfibersamples'</span>}
0144     <span class="comment">% fefgGet(fg,'n samples per fiber ')</span>
0145     <span class="comment">% How many samples per fiber.  This is about equal to</span>
0146     <span class="comment">% their length in mm, though we need to write the fiber lengths</span>
0147     <span class="comment">% routine to actually calculate this.</span>
0148     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'n fibers'</span>);
0149     val = zeros(1,nFibers);
0150     <span class="keyword">for</span> ii=1:nFibers
0151       val(ii) = length(fg.fibers{ii});
0152     <span class="keyword">end</span>
0153     
0154     <span class="comment">% Fiber group (subgroup) properties.</span>
0155     <span class="comment">% These are used when we classify fibers into subgroups.  We should</span>
0156     <span class="comment">% probably clean up this organization which is currently</span>
0157     <span class="comment">%</span>
0158     <span class="comment">%   subgroup - length of fibers, an index of group identity</span>
0159     <span class="comment">%   subgroupNames()</span>
0160     <span class="comment">%    .subgroupIndex - Probably should go away and the index should</span>
0161     <span class="comment">%          just be</span>
0162     <span class="comment">%    .subgroupName  - Probably should be moved up.</span>
0163     <span class="comment">%</span>
0164   <span class="keyword">case</span> {<span class="string">'ngroups'</span>,<span class="string">'nsubgroups'</span>}
0165     val = length(fg.subgroupNames);
0166   <span class="keyword">case</span> {<span class="string">'groupnames'</span>}
0167     val = cell(1,<a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'n groups'</span>));
0168     <span class="keyword">for</span> ii=1:nGroups
0169       val{ii} = fg.subgroupNames(ii).subgroupName;
0170     <span class="keyword">end</span>
0171     
0172     <span class="comment">% DTI properties</span>
0173   <span class="keyword">case</span> <span class="string">'tensors'</span>
0174     val = fg.tensors;
0175     
0176     <span class="comment">% Fiber to coord calculations</span>
0177   <span class="keyword">case</span> {<span class="string">'imagecoords'</span>}
0178     <span class="comment">% c = fefgGet(fgAcpc,'image coords',fgList,xForm);</span>
0179     <span class="comment">% c = fefgGet(fgAcpc,'image coords',fgList,xForm);</span>
0180     <span class="comment">%</span>
0181     <span class="comment">% Return the image coordinates of a specified list of fibers</span>
0182     <span class="comment">% Returns a matrix that is fgList by 3 of the image coordinates for</span>
0183     <span class="comment">% each node of each fiber.</span>
0184     <span class="comment">%</span>
0185     <span class="comment">% Fiber coords are represented at fine resolution in ACPC space.</span>
0186     <span class="comment">% These coordinates are rounded and in image space</span>
0187     <span class="keyword">if</span> ~isempty(varargin)
0188       fList = varargin{1};
0189       <span class="keyword">if</span> length(varargin) &gt; 1
0190         xForm = varargin{2};
0191         <span class="comment">% Put the fiber coordinates into image space</span>
0192         fg = dtiXformFiberCoords(fg,xForm);
0193       <span class="keyword">end</span>
0194     <span class="keyword">else</span>
0195       <span class="comment">% In this case, the fiber coords should already be in image</span>
0196       <span class="comment">% space.</span>
0197       nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'n fibers'</span>);
0198       fList = 1:nFibers;
0199     <span class="keyword">end</span>
0200     
0201     <span class="comment">% Pull out the coordinates and ceil them.  These are in image</span>
0202     <span class="comment">% space.</span>
0203     nFibers = length(fList);
0204     val = cell(1,nFibers);
0205     <span class="keyword">if</span> nFibers == 1
0206       val = ceil(fg.fibers{fList(1)}')+1;
0207 
0208     <span class="keyword">else</span>
0209       <span class="comment">% Handling parallel processing</span>
0210       poolwasopen=1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0211       <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0212       parfor ii=1:nFibers
0213         val{ii} = ceil(fg.fibers{fList(ii)}')+1;
0214       <span class="keyword">end</span>
0215       <span class="keyword">if</span> ~poolwasopen, matlabpool close; <span class="keyword">end</span>
0216     <span class="keyword">end</span>
0217 
0218   <span class="keyword">case</span> {<span class="string">'uniqueimagecoords'</span>}
0219     <span class="comment">%   coords = fefgGet(fgIMG,'unique image coords');</span>
0220     <span class="comment">%</span>
0221     <span class="comment">% The fg input must be in IMG space.</span>
0222     <span class="comment">%</span>
0223     <span class="comment">% Returns the unique image coordinates of all the fibers as an Nx3</span>
0224     <span class="comment">% matrix of integers.</span>
0225     <span class="comment">% val = round(horzcat(fg.fibers{:})');</span>
0226     val = ceil(horzcat(fg.fibers{:})')+1;
0227     val = unique(val,<span class="string">'rows'</span>);
0228   
0229     <span class="keyword">case</span> {<span class="string">'allimagecoords'</span>}
0230     <span class="comment">%   coords = fefgGet(fgIMG,'all image coords');</span>
0231     <span class="comment">%</span>
0232     <span class="comment">% The fg input must be in IMG space.</span>
0233     <span class="comment">%</span>
0234     <span class="comment">% Returns all image coordinates of all the fibers as an Nx3</span>
0235     <span class="comment">% matrix of integers.</span>
0236     <span class="comment">% val = round(horzcat(fg.fibers{:})');</span>
0237     val = ceil(horzcat(fg.fibers{:})')+1;
0238     
0239   <span class="keyword">case</span> {<span class="string">'uniqueacpccoords'</span>}
0240     <span class="comment">%   coords = fefgGet(fg,'unique acpc coords');</span>
0241     <span class="comment">%</span>
0242     <span class="comment">% The fg input must be in ACPC space.</span>
0243     <span class="comment">%</span>
0244     <span class="comment">% Returns the unique ACPC coordinates of all the fibers as an Nx3</span>
0245     <span class="comment">% matrix of integers.</span>
0246     val = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg, <span class="string">'uniqueimagecoords'</span>) ;
0247 
0248   <span class="keyword">case</span> {<span class="string">'nodes2voxels'</span>}
0249     <span class="comment">%   nodes2voxels = fefgGet(fgImg,'nodes2voxels',roiCoords)</span>
0250     <span class="comment">%</span>
0251     <span class="comment">% The roiCoords are a matrix of Nx3 coordinates.  They describe a</span>
0252     <span class="comment">% region of interest, typically in image space or possibly in acpc</span>
0253     <span class="comment">% space.</span>
0254     <span class="comment">%</span>
0255     <span class="comment">% We return a cell array that is a mapping of fiber nodes to voxels in</span>
0256     <span class="comment">% the roi.  The roi is specified as an Nx3 matrix of coordinates.</span>
0257     <span class="comment">% The returned cell array, nodes2voxels, has the same number of</span>
0258     <span class="comment">% cells as there are fibers.</span>
0259     <span class="comment">%</span>
0260     <span class="comment">% Unlike the fiber group cells, which have a 3D coordinate of each</span>
0261     <span class="comment">% node, this cell array has an integer that indexes the row of</span>
0262     <span class="comment">% roiCoords that contains the node. If a node is not in any of the</span>
0263     <span class="comment">% roiCoords, the entry in node2voxels{ii} for that node is zero.</span>
0264     <span class="comment">% This means that node is outside the 'roiCoords'.</span>
0265     <span class="comment">%</span>
0266     <span class="comment">% Once again: The cell nodes2voxels{ii} specifies whether each</span>
0267     <span class="comment">% node in the iith fiber is inside a voxel in the roiCoords.  The</span>
0268     <span class="comment">% value specifies the row in roiCoords that contains the node.</span>
0269     <span class="comment">%</span>
0270     <span class="keyword">if</span> isempty(varargin), error(<span class="string">'roiCoords required'</span>);
0271     <span class="keyword">else</span>
0272       roiCoords = varargin{1};
0273     <span class="keyword">end</span>
0274     fprintf(<span class="string">'[%s] Computing nodes-to-voxels..'</span>,mfilename)
0275 
0276     <span class="comment">% Find the roiCoord for each node in each fiber.</span>
0277     nFiber = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'n fibers'</span>);
0278     val    = cell(nFiber,1);
0279     
0280     <span class="comment">% Handling parallel processing</span>
0281     poolwasopen=1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0282     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0283     parfor ii=1:nFiber
0284      <span class="comment">% if ~mod(ii,200), fprintf('%d ',ii); end</span>
0285      <span class="comment">% Node coordinates in image space</span>
0286      nodeCoords = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'image coords'</span>,ii);
0287      
0288      <span class="comment">% The values in loc are the row of the coords matrix that contains</span>
0289      <span class="comment">% that sample point in a fiber.  For example, if the number 100 is</span>
0290      <span class="comment">% in the 10th position of loc, then the 10th sample point in the</span>
0291      <span class="comment">% fiber passes through the voxel in row 100 of coords.</span>
0292      <span class="comment">%keyboard</span>
0293      [~, val{ii}] = ismember(nodeCoords, roiCoords, <span class="string">'rows'</span>);  <span class="comment">% This operation is slow.</span>
0294     <span class="keyword">end</span>    
0295     <span class="keyword">if</span> ~poolwasopen, matlabpool close; <span class="keyword">end</span>
0296     fprintf(<span class="string">' took: %2.3fminutes.\n'</span>,toc/60)
0297 
0298   <span class="keyword">case</span> {<span class="string">'voxel2fibernodepairs'</span>,<span class="string">'v2fn'</span>}
0299     <span class="comment">% voxel2FNpairs = fefgGet(fgImg,'voxel 2 fibernode pairs',roiCoords);</span>
0300     <span class="comment">% voxel2FNpairs = fefgGet(fgImg,'voxel 2 fibernode pairs',roiCoords,nodes2voxels);</span>
0301     <span class="comment">%</span>
0302     <span class="comment">% The return is a cell array whose size is the number of voxels.</span>
0303     <span class="comment">% The cell is a Nx2 matrix of the (fiber, node) pairs that pass</span>
0304     <span class="comment">% through it.</span>
0305     <span class="comment">%</span>
0306     <span class="comment">% The value N is the number of nodes in the voxel.  The first</span>
0307     <span class="comment">% column is the fiber number.  The second column reports the indexes</span>
0308     <span class="comment">% of the nodes for each fiber in each voxel.</span>
0309     fprintf(<span class="string">'[%s] Computing fibers/nodes pairing in each voxel..\n'</span>,mfilename)
0310    
0311     <span class="keyword">if</span> (length(varargin) &lt; 1), error(<span class="string">'Requires the roiCoords.'</span>);
0312     <span class="keyword">else</span>
0313       roiCoords = varargin{1};
0314       nCoords   = size(roiCoords,1);
0315     <span class="keyword">end</span>
0316     <span class="keyword">if</span> length(varargin) &lt; 2
0317       <span class="comment">% We assume the fg and the ROI coordinates are in the same</span>
0318       <span class="comment">% coordinate frame.</span>
0319       tic,nodes2voxels    = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nodes 2 voxels'</span>,roiCoords);
0320     <span class="keyword">else</span> nodes2voxels = varargin{2};
0321     <span class="keyword">end</span>
0322     
0323     nFibers      = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0324     voxelsInFG   = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'voxels in fg'</span>,nodes2voxels);      
0325 
0326     tic,roiNodesInFG = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nodes in voxels'</span>,nodes2voxels);
0327     tic, val = cell(1,nCoords);
0328     <span class="keyword">for</span> thisFiber=1:nFibers
0329       voxelsInFiber = voxelsInFG{thisFiber};   <span class="comment">% A few voxels, in a list</span>
0330       nodesInFiber  = roiNodesInFG{thisFiber}; <span class="comment">% The corresponding nodes</span>
0331       
0332       <span class="comment">% Then add a row for each (fiber,node) pairs that pass through</span>
0333       <span class="comment">% the voxels for this fiber.</span>
0334       <span class="keyword">for</span> jj=1:length(voxelsInFiber)
0335         thisVoxel = voxelsInFiber(jj);
0336         <span class="comment">% Print out roi coord and fiber coord to verify match</span>
0337         <span class="comment">% roiCoords(thisVoxel,:)</span>
0338         <span class="comment">% fg.fibers{thisFiber}(:,nodesInFiber(jj))</span>
0339         <span class="comment">% Would horzcat be faster?</span>
0340         val{thisVoxel} = cat(1,val{thisVoxel},[thisFiber,nodesInFiber(jj)]);
0341       <span class="keyword">end</span>
0342     <span class="keyword">end</span>
0343     fprintf(<span class="string">'[%s] fiber/node pairing completed in: %2.3fs.\n'</span>,mfilename, toc)
0344   
0345   <span class="keyword">case</span> {<span class="string">'voxel2fibers'</span>,<span class="string">'fiberdensity'</span>}
0346     <span class="comment">% voxel2FNpairs = fefgGet(fgImg,'fiber density',roiCoords);</span>
0347     <span class="comment">%</span>
0348     <span class="comment">% The return is a cell array whose size is the number of voxels.</span>
0349     <span class="comment">% The cell is a Nx1 matrix of fiber counts. How many fibers in each</span>
0350     <span class="comment">% voxel.</span>
0351     <span class="comment">%</span>
0352     fprintf(<span class="string">'[%s] Computing fiber density in each voxel...\n'</span>,mfilename)
0353    
0354     <span class="keyword">if</span> (length(varargin) &lt; 1), 
0355       roiCoords = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'uniqueimagecoords'</span>);
0356       fprintf(<span class="string">'[%s] Computing white-matter volume ROI from fibers coordinates.\n'</span>,mfilename) 
0357       fprintf(<span class="string">'          Assuming fiber coordinates in IMG space.\n'</span>)
0358     <span class="keyword">else</span>
0359       roiCoords = varargin{1};
0360     <span class="keyword">end</span>
0361     
0362     <span class="keyword">if</span> length(varargin) &lt; 2
0363       <span class="comment">% We assume the fg and the ROI coordinates are in the same</span>
0364       <span class="comment">% coordinate frame.</span>
0365       tic,nodes2voxels= <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nodes 2 voxels'</span>,roiCoords);
0366     <span class="keyword">else</span> nodes2voxels = varargin{2};
0367     <span class="keyword">end</span>
0368     
0369     nCoords      = size(roiCoords,1);
0370     nFibers      = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0371     voxelsInFG   = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'voxels in fg'</span>,nodes2voxels);      
0372 
0373     tic, fibersInVox = cell(1,nCoords);
0374     <span class="keyword">for</span> thisFiber=1:nFibers
0375       voxelsInFiber = voxelsInFG{thisFiber};   <span class="comment">% A few voxels, in a list</span>
0376       
0377       <span class="comment">% Then add a row for each (fiber,node) pairs that pass through</span>
0378       <span class="comment">% the voxels for this fiber.</span>
0379       <span class="keyword">for</span> jj=1:length(voxelsInFiber)
0380         thisVoxel = voxelsInFiber(jj);
0381         <span class="comment">% Print out roi coord and fiber coord to verify match</span>
0382         <span class="comment">% roiCoords(thisVoxel,:)</span>
0383         <span class="comment">% fg.fibers{thisFiber}(:,nodesInFiber(jj))</span>
0384         <span class="comment">% Would horzcat be faster?</span>
0385         fibersInVox{thisVoxel} = cat(1,fibersInVox{thisVoxel},thisFiber);
0386       <span class="keyword">end</span>
0387     <span class="keyword">end</span>
0388     
0389     <span class="comment">% Now create the fiber density, the unique fibers in each voxel</span>
0390     val = zeros(length(fibersInVox),1);
0391     <span class="keyword">for</span> ivx = 1:length(fibersInVox)
0392       val(ivx) = length(unique(fibersInVox{ivx}));
0393     <span class="keyword">end</span>
0394     
0395     fprintf(<span class="string">'[%s] fiber density completed in: %2.3fs.\n'</span>,mfilename, toc)
0396   
0397   <span class="keyword">case</span> {<span class="string">'uniquefibersinvox'</span>}
0398     <span class="comment">% uniquefvx = fefgGet(fgImg,'uniquefibrsinvox',roiCoords);</span>
0399     <span class="comment">%</span>
0400     <span class="comment">% The return is a vector whose size is the number of voxels containing</span>
0401     <span class="comment">% the unique fibers in each voxel</span>
0402     <span class="comment">%</span>
0403     fprintf(<span class="string">'[%s] Computing the unique fibers in each voxel...\n'</span>,mfilename)
0404     tic
0405     <span class="keyword">if</span> (length(varargin) &lt; 1), error(<span class="string">'Requires the roiCoords.'</span>);
0406     <span class="keyword">else</span>
0407       roiCoords = varargin{1};
0408       nCoords   = size(roiCoords,1);
0409     <span class="keyword">end</span>
0410     
0411     <span class="comment">% We assume the fg and the ROI coordinates are in the same</span>
0412     <span class="comment">% coordinate frame.</span>
0413     nodes2voxels    = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nodes 2 voxels'</span>,roiCoords);
0414     
0415     nFibers      = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0416     voxelsInFG   = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'voxels in fg'</span>,nodes2voxels);      
0417 
0418     fibersInVox = cell(1,nCoords);
0419     <span class="keyword">for</span> thisFiber=1:nFibers
0420       voxelsInFiber = voxelsInFG{thisFiber};   <span class="comment">% A few voxels, in a list</span>
0421       
0422       <span class="comment">% Then add a row for each (fiber,node) pairs that pass through</span>
0423       <span class="comment">% the voxels for this fiber.</span>
0424       <span class="keyword">if</span> ~isempty(voxelsInFiber)
0425           <span class="keyword">for</span> jj=1:length(voxelsInFiber)
0426               thisVoxel = voxelsInFiber(jj);
0427               fibersInVox{thisVoxel} = cat(1,fibersInVox{thisVoxel},thisFiber);
0428           <span class="keyword">end</span>
0429       <span class="keyword">end</span>
0430     <span class="keyword">end</span>
0431     
0432     <span class="comment">% Now create find the unique fibers in each voxel</span>
0433     val = cell(length(fibersInVox),1);
0434     <span class="keyword">for</span> ivx = 1:length(fibersInVox)
0435       val{ivx} = (unique(fibersInVox{ivx}));
0436     <span class="keyword">end</span>
0437     fprintf(<span class="string">'[%s] done computing unique fibers in each voxel: %2.3fs.\n'</span>,mfilename, toc)
0438 
0439   <span class="keyword">case</span> {<span class="string">'nodesinvoxels'</span>}
0440     <span class="comment">% nodesInVoxels = fefgGet(fg,'nodes in voxels',nodes2voxels);</span>
0441     <span class="comment">%</span>
0442     <span class="comment">% This cell array is a modified form of nodes2voxels (see above).</span>
0443     <span class="comment">% In that cell array every node in every fiber has a number</span>
0444     <span class="comment">% referring to its row in roiCoords, or a 0 when the node is not in</span>
0445     <span class="comment">% any roiCoord voxel.</span>
0446     <span class="comment">%</span>
0447     <span class="comment">% This cell array differs only in that the 0s removed.  This</span>
0448     <span class="comment">% is used to simplify certain calculations.</span>
0449     <span class="comment">%</span>
0450     <span class="keyword">if</span> (length(varargin) &lt;1), error(<span class="string">'Requires nodes2voxels cell array.'</span>); <span class="keyword">end</span>
0451     tic,fprintf(<span class="string">'[%s] Computing nodes-in-voxels..'</span>,mfilename)
0452     nodes2voxels = varargin{1};
0453     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0454     val     = cell(1,nFibers);
0455  
0456     <span class="comment">% Handling parallel processing</span>
0457     poolwasopen=1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0458     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0459     <span class="comment">% For each fiber, this is a list of the nodes that pass through</span>
0460     <span class="comment">% a voxel in the roiCoords</span>
0461     parfor ii = 1:nFibers
0462       <span class="comment">% For each fiber, this is a list of the nodes that pass through</span>
0463       <span class="comment">% a voxel in the roiCoords</span>
0464       lst = (nodes2voxels{ii} ~= 0);
0465       val{ii} = find(lst);
0466     <span class="keyword">end</span>
0467     <span class="keyword">if</span> ~poolwasopen, matlabpool close; <span class="keyword">end</span>
0468     fprintf(<span class="string">' took: %2.3fs.\n'</span>,toc)
0469 
0470   <span class="keyword">case</span> <span class="string">'voxelsinfg'</span>
0471     <span class="comment">% voxelsInFG = fefgGet(fgImg,'voxels in fg',nodes2voxels);</span>
0472     <span class="comment">%</span>
0473     <span class="comment">% A cell array length n-fibers. Each cell has a list of the voxels</span>
0474     <span class="comment">% (rows of roiCoords) for a fiber.</span>
0475     <span class="comment">%</span>
0476     <span class="comment">% This routine eliminates the 0's in the nodes2voxels lists.</span>
0477     <span class="comment">%</span>
0478     <span class="keyword">if</span> length(varargin) &lt; 1, error(<span class="string">'Requires nodes2voxels cell array.'</span>); <span class="keyword">end</span>
0479     tic,fprintf(<span class="string">'[%s] Computing voxels-in-fg..'</span>,mfilename)
0480 
0481     nodes2voxels = varargin{1};
0482     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0483     val = cell(1,nFibers);
0484  
0485     <span class="comment">% Handling parallel processing</span>
0486     poolwasopen=1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0487     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0488      parfor ii = 1:nFibers
0489       <span class="comment">% These are the nodes that pass through a voxel in the</span>
0490       <span class="comment">% roiCoords</span>
0491       lst = (nodes2voxels{ii} ~= 0);
0492       val{ii} = nodes2voxels{ii}(lst);
0493     <span class="keyword">end</span>
0494     <span class="keyword">if</span> ~poolwasopen, matlabpool close; <span class="keyword">end</span>
0495     fprintf(<span class="string">' took: %2.3fs.\n'</span>,toc)
0496 
0497   <span class="keyword">case</span> {<span class="string">'voxels2fibermatrix'</span>,<span class="string">'v2fm'</span>}
0498     <span class="comment">%   v2fm = fefgGet(fgImg,'voxels 2 fiber matrix',roiCoords);</span>
0499     <span class="comment">% Or,</span>
0500     <span class="comment">%   v2fnPairs = fefgGet(fgImg,'v2fn',roiCoords);</span>
0501     <span class="comment">%   v2fm = fefgGet(fgImg,'voxels 2 fiber matrix',roiCoords, v2fnPairs);</span>
0502     <span class="comment">%</span>
0503     <span class="comment">% mrvNewGraphWin; imagesc(v2fm)</span>
0504     <span class="comment">%</span>
0505     <span class="comment">% Returns a binary matrix of size Voxels by Fibers.</span>
0506     <span class="comment">% When voxel ii has at least one node from fiber jj, there is a one</span>
0507     <span class="comment">% in v2fm(ii,jj).  Otherwise, the entry is zero.</span>
0508     <span class="comment">%</span>
0509     
0510     <span class="comment">% Check that the fg is in the image coordspace:</span>
0511     <span class="keyword">if</span> isfield(fg, <span class="string">'coordspace'</span>) &amp;&amp; ~strcmp(fg.coordspace, <span class="string">'img'</span>)
0512       error(<span class="string">'Fiber group is not in the image coordspace, please xform'</span>);
0513     <span class="keyword">end</span>
0514     
0515     <span class="keyword">if</span> isempty(varargin), error(<span class="string">'roiCoords required'</span>);
0516     <span class="keyword">else</span>
0517       roiCoords = varargin{1};
0518       nCoords   = size(roiCoords,1);
0519       <span class="keyword">if</span> length(varargin) &lt; 2
0520         v2fnPairs = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'v2fn'</span>,roiCoords);
0521       <span class="keyword">else</span>
0522         v2fnPairs = varargin{2};
0523       <span class="keyword">end</span>
0524     <span class="keyword">end</span>
0525     
0526     <span class="comment">% Allocate matrix of voxels by fibers</span>
0527     val = zeros(nCoords,<a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'n fibers'</span>));
0528     
0529     <span class="comment">% For each coordinate, find the fibers.  Set those entries to 1.</span>
0530     <span class="keyword">for</span> ii=1:nCoords
0531       <span class="keyword">if</span> ~isempty(v2fnPairs{ii})
0532         f = unique(v2fnPairs{ii}(:,1));
0533       <span class="keyword">end</span>
0534       val(ii,f) = 1;
0535     <span class="keyword">end</span>
0536     
0537   <span class="keyword">case</span> {<span class="string">'fibersinroi'</span>,<span class="string">'fginvoxels'</span>,<span class="string">'fibersinvoxels'</span>}
0538     <span class="comment">% fList = fefgGet(fgImg,'fibersinroi',roiCoords);</span>
0539     <span class="comment">%</span>
0540     <span class="comment">% v2fn = fefgGet(fgImg,'v2fn',roiCoords);</span>
0541     <span class="comment">% fList = fefgGet(fgImg,'fibersinroi',roiCoords,v2fn);</span>
0542     <span class="comment">%</span>
0543     <span class="comment">% Returns an integer vector of the fibers with at least</span>
0544     <span class="comment">% one node in a region of interest.</span>
0545     <span class="comment">%</span>
0546     <span class="comment">% The fg and roiCoords should be in the same coordinate frame.</span>
0547     <span class="comment">%</span>
0548     <span class="keyword">if</span> isempty(varargin), error(<span class="string">'roiCoords required'</span>);
0549     <span class="keyword">elseif</span> length(varargin) == 1
0550       roiCoords = varargin{1};
0551       v2fnPairs = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'v2fn'</span>,roiCoords);
0552     <span class="keyword">elseif</span> length(varargin) &gt; 1
0553       roiCoords = varargin{1};
0554       v2fnPairs = varargin{2};
0555     <span class="keyword">end</span>
0556     
0557     val = []; nCoords = size(roiCoords,1);
0558     <span class="keyword">for</span> ii=1:nCoords
0559       <span class="keyword">if</span> ~isempty(v2fnPairs{ii})
0560         val = cat(1,val,v2fnPairs{ii}(:,1));
0561       <span class="keyword">end</span>
0562     <span class="keyword">end</span>
0563     val = sort(unique(val),<span class="string">'ascend'</span>);
0564     
0565   <span class="keyword">case</span> {<span class="string">'coordspace'</span>,<span class="string">'fibercoordinatespace'</span>,<span class="string">'fcspace'</span>}
0566     <span class="comment">% In some cases, the fg might contain information telling us in which</span>
0567     <span class="comment">% coordinate space its coordinates are set. This information is set</span>
0568     <span class="comment">% as a struct. Each entry in the struct can be either a 4x4 xform</span>
0569     <span class="comment">% matrix from the fiber coordinates to that space (with eye(4) for</span>
0570     <span class="comment">% the space in which the coordinates are defined), or (if the xform</span>
0571     <span class="comment">% is not know) an empty matrix.</span>
0572     
0573     cspace_fields = fields(fg.coordspace);
0574     val = [];
0575     <span class="keyword">for</span> f=1:length(cspace_fields)
0576       this_field = cspace_fields{f};
0577       <span class="keyword">if</span> isequal(getfield(fg.coordspace, this_field), eye(4))
0578         val = this_field;
0579       <span class="keyword">end</span>
0580     <span class="keyword">end</span>
0581   
0582   <span class="keyword">case</span> {<span class="string">'length'</span>}
0583     <span class="comment">% Returns the length of each fiber in the fiber group</span>
0584     <span class="comment">% flen = fefgGet(fg,'length')</span>
0585     
0586     <span class="comment">% Measure the step size of the first fiber. They *should* all be the same!</span>
0587     stepSize = mean(sqrt(sum(diff(fg.fibers{1},1,2).^2)));
0588     
0589     <span class="comment">% Check that they are</span>
0590     <span class="comment">%stepSize2 = mean(sqrt(sum(diff(fg.fibers{2},1,2).^2)));</span>
0591     <span class="comment">%assertElementsAlmostEqual(stepSize,stepSize2,'relative',.001,.001);</span>
0592     
0593     <span class="comment">% Estimate the length for the fibers, as well mean, min and max</span>
0594     val  = cellfun(<span class="string">'length'</span>,fg.fibers)*stepSize;
0595   
0596   <span class="keyword">case</span> {<span class="string">'dt6'</span>}
0597     <span class="comment">% Compute the 6 parameters for the tensors at each node in each fiber.</span>
0598     <span class="comment">% It requires a dt structure.</span>
0599     <span class="comment">% dt6 = fefgGet(fg,'dt6',dt)</span>
0600     <span class="comment">% dt6 = fefgGet(fg,'dt6',dtFileName)</span>
0601 
0602     <span class="keyword">if</span> ~ischar(varargin{1})    
0603       <span class="keyword">if</span> isstruct(varargin{1})
0604         <span class="comment">% A dti structure was passed.</span>
0605         dt = varargin{1};
0606       <span class="keyword">else</span>
0607         error(<span class="string">'[%s] A ''dt'' structure is necessary.'</span>, mfilename)
0608       <span class="keyword">end</span>
0609     <span class="keyword">else</span> <span class="comment">% The string should be a path to a dt.mat file.</span>
0610       dt = dtiLoadDt6(varargin{1});
0611     <span class="keyword">end</span>
0612     
0613     <span class="comment">% Get the dt6 tensors for each node in each fiber.</span>
0614     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0615     val     = cell(1,nFibers);
0616     xform   = inv(dt.xformToAcpc);
0617     dt6     = dt.dt6; clear dt
0618     
0619     <span class="comment">% Handling parallel processing</span>
0620     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0621     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0622     parfor ii = 1:nFibers
0623       <span class="comment">% Get the fiber coordinates.</span>
0624       coords = fg.fibers{ii}'; <span class="comment">% Assumed in ACPC</span>
0625       
0626       [val1,val2,val3,val4,val5,val6] = <span class="keyword">...</span>
0627         dtiGetValFromTensors(dt6, coords, xform,<span class="string">'dt6'</span>,<span class="string">'nearest'</span>);
0628       
0629       <span class="comment">% Build a vector of tesnsors' eigenvalues</span>
0630       val{ii} = [val1,val2,val3,val4,val5,val6];
0631     <span class="keyword">end</span>
0632     
0633     
0634   <span class="keyword">case</span> {<span class="string">'eigenvals'</span>}
0635     <span class="comment">% Compute eigenvalues for the fibers in a fiber group.</span>
0636     <span class="comment">% It requires a dt structure.</span>
0637     <span class="comment">% eigenvals = fefgGet(fg,'eigenvals',dt)</span>
0638     <span class="comment">% eigenvals = fefgGet(fg,'eigenvals',dt6FileName)</span>
0639     <span class="keyword">if</span> ~ischar(varargin{1})
0640       <span class="keyword">if</span> ( ~isstruct(varargin{1}) )
0641         dt6 = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'dt6'</span>,varargin{1});
0642       <span class="keyword">elseif</span> ( size(varargin{1},1)==6 )
0643         dt6 = varargin{1};
0644       <span class="keyword">else</span>
0645         error(<span class="string">'[%s] Either a ''dt'' structure or a ''dt6'' vector of tensor coefficients is necessary.\n'</span>,mfilename)
0646       <span class="keyword">end</span>
0647     <span class="keyword">else</span> <span class="comment">% The string should be a path to a dt6.mat file.</span>
0648       dt6 = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'dt6'</span>,dtiLoadDt6(varargin{1}));
0649     <span class="keyword">end</span>
0650     
0651     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0652     val     = cell(1,nFibers);
0653  
0654     <span class="comment">% Handling parallel processing</span>
0655     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0656     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0657     parfor ii = 1:nFibers
0658       
0659       <span class="comment">% We now have the dt6 data from all of the fibers.  We extract the</span>
0660       <span class="comment">% directions into vec and the eigenvalues into val.  The units of val are</span>
0661       <span class="comment">% um^2/sec or um^2/msec .. somebody answer this here, please.</span>
0662       [~,val{ii}] = dtiEig(dt6{ii});
0663     <span class="keyword">end</span>
0664     
0665     <span class="keyword">for</span>  ii = 1:nFibers
0666       <span class="comment">% Some of the ellipsoid fits are wrong and we get negative eigenvalues.</span>
0667       <span class="comment">% These are annoying. If they are just a little less than 0, then clipping</span>
0668       <span class="comment">% to 0 is not an entirely unreasonable thing. Maybe we should check for the</span>
0669       <span class="comment">% magnitude of the error?</span>
0670       nonPD = find(any(val{ii}&lt;0,2), 1);
0671       <span class="keyword">if</span>(~isempty(nonPD))
0672         <span class="comment">%fprintf('\n NOTE: %d fiber points had negative eigenvalues. These will be clipped to 0..\n',length(nonPD));</span>
0673         val{ii}(val{ii}&lt;0) = 0;
0674       <span class="keyword">end</span>
0675       
0676       threeZeroVals = (sum(val{ii}, 2) == 0);
0677       <span class="comment">%if ~isempty (threeZeroVals)</span>
0678       <span class="comment">%  fprintf('\n NOTE: %d of these fiber points had all three negative eigenvalues. These will be excluded from analyses\n', length(threeZeroVals));</span>
0679       <span class="comment">%end</span>
0680       val{ii}(threeZeroVals, :)=[];
0681     <span class="keyword">end</span>
0682     
0683   <span class="keyword">case</span> {<span class="string">'fa'</span>}
0684     <span class="comment">% Compute the FA for all the fibers in the fiber group.</span>
0685     <span class="comment">% Requires a dt structure.</span>
0686     <span class="comment">% fa = fefgGet(fg,'fa',dt)</span>
0687     <span class="comment">% fa = fefgGet(fg,'fa',eigenvals)</span>
0688     <span class="comment">% fa = fefgGet(fg,'fa',dtFileName)</span>
0689     <span class="keyword">if</span> (~isstruct(varargin{1}) || ischar(varargin{1})) &amp;&amp; ~iscell(varargin{1})
0690       <span class="comment">% A dti structue was passed.</span>
0691       eigenvals = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'eigenvals'</span>,varargin{1});
0692     <span class="keyword">else</span>
0693       <span class="comment">% We assume that eigenvals were passed already</span>
0694       eigenvals = varargin{1};
0695     <span class="keyword">end</span>
0696     
0697     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0698     val     = cell(1,nFibers);
0699     
0700     <span class="comment">% Handling parallel processing</span>
0701     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0702     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0703     parfor ii = 1:nFibers    
0704       [val{ii},~,~,~] = dtiComputeFA(eigenvals{ii});
0705     <span class="keyword">end</span>
0706     
0707   <span class="keyword">case</span> {<span class="string">'md'</span>}
0708     <span class="comment">% Compute the Mean Diffusivity for all the fibers in the fiber group.</span>
0709     <span class="comment">% Requires a dt structure.</span>
0710     <span class="comment">% md = fefgGet(fg,'md',dt)</span>
0711     <span class="comment">% md = fefgGet(fg,'md',eigenvals)</span>
0712     <span class="comment">% md = fefgGet(fg,'md',dtFileName)</span>
0713 
0714     <span class="keyword">if</span> (~isstruct(varargin{1}) || ischar(varargin{1})) &amp;&amp; ~iscell(varargin{1})
0715       <span class="comment">% A dti structue was passed.</span>
0716       eigenvals = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'eigenvals'</span>,varargin{1});
0717     <span class="keyword">else</span>
0718       <span class="comment">% We assume that eigenvals were passed already</span>
0719       eigenvals = varargin{1};
0720     <span class="keyword">end</span>
0721     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0722     val     = cell(1,nFibers);
0723     
0724     <span class="comment">% Handling parallel processing</span>
0725     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0726     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0727     parfor ii = 1:nFibers    
0728       [~,val{ii},~,~] = dtiComputeFA(eigenvals{ii});
0729     <span class="keyword">end</span>
0730        
0731   <span class="keyword">case</span> {<span class="string">'ad'</span>}
0732     <span class="comment">% Compute the Axial Diffusivity for all the fibers in the fiber group.</span>
0733     <span class="comment">% Requires a dt structure.</span>
0734     <span class="comment">% ad = fefgGet(fg,'ad',dt)</span>
0735     <span class="comment">% ad = fefgGet(fg,'ad',eigenvals)</span>
0736     <span class="comment">% ad = fefgGet(fg,'ad',dtFileName)</span>
0737 
0738     <span class="keyword">if</span> (~isstruct(varargin{1}) || ischar(varargin{1})) &amp;&amp; ~iscell(varargin{1}) 
0739       <span class="comment">% A dti structue was passed.</span>
0740       eigenvals = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'eigenvals'</span>,varargin{1});
0741     <span class="keyword">else</span>
0742       <span class="comment">% We assume that eigenvals were passed already</span>
0743       eigenvals = varargin{1};
0744     <span class="keyword">end</span>
0745     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0746     val     = cell(1,nFibers);
0747     
0748     <span class="comment">% Handling parallel processing</span>
0749     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0750     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0751     parfor ii = 1:nFibers    
0752       [~,~,~,val{ii}] = dtiComputeFA(eigenvals{ii});
0753     <span class="keyword">end</span>
0754         
0755   <span class="keyword">case</span> {<span class="string">'rd'</span>}
0756     <span class="comment">% Compute the Radial Diffusivity for all the fibers in the fiber group.</span>
0757     <span class="comment">% Requires a dt structure.</span>
0758     <span class="comment">% rd = fefgGet(fg,'rd',dt)</span>
0759     <span class="comment">% rd = fefgGet(fg,'rd',eigenvals)</span>
0760     <span class="comment">% rd = fefgGet(fg,'rd',dtFileName)</span>
0761 
0762     <span class="keyword">if</span> (~isstruct(varargin{1}) || ischar(varargin{1})) &amp;&amp; ~iscell(varargin{1}) 
0763       <span class="comment">% A dti structue was passed.</span>
0764       eigenvals = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'eigenvals'</span>,varargin{1});
0765     <span class="keyword">else</span>
0766       <span class="comment">% We assume that eigenvals were passed already</span>
0767       eigenvals = varargin{1};
0768     <span class="keyword">end</span>
0769     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0770     val     = cell(1,nFibers);
0771     
0772     <span class="comment">% Handling parallel processing</span>
0773     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0774     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0775     parfor ii = 1:nFibers    
0776       [~,~,val{ii},~] = dtiComputeFA(eigenvals{ii});
0777     <span class="keyword">end</span>
0778     
0779   <span class="keyword">case</span> {<span class="string">'adc'</span>}
0780     <span class="comment">% Compute the radial and axial ADC for all the fibers in the fiber group.</span>
0781     <span class="comment">% Requires a dt structure.</span>
0782     <span class="comment">% adc = fefgGet(fg,'adc',dt)</span>
0783     <span class="comment">% adc = fefgGet(fg,'adc',eigenvals)</span>
0784     <span class="comment">% adc = fefgGet(fg,'adc',dtFileName)</span>
0785     
0786     <span class="keyword">if</span> (~isstruct(varargin{1}) || ischar(varargin{1})) &amp;&amp; ~iscell(varargin{1}) 
0787       <span class="comment">% A dti structue was passed.</span>
0788       eigenvals = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'eigenvals'</span>,varargin{1});
0789     <span class="keyword">else</span>
0790       <span class="comment">% We assume that eigenvals were passed already</span>
0791       eigenvals = varargin{1};
0792     <span class="keyword">end</span>
0793     
0794     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0795     val     = cell(1,nFibers);
0796     <span class="comment">% Handling parallel processing</span>
0797     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0798     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0799     parfor ii = 1:nFibers
0800       [~,~,val{ii}.radial, val{ii}.axial] = dtiComputeFA(eigenvals{ii});
0801     <span class="keyword">end</span>
0802     
0803   <span class="keyword">case</span> {<span class="string">'westinshape'</span>}
0804     <span class="comment">% Compute the Westin shape parameters (linearity and planarity)</span>
0805     <span class="comment">% for all the fibers in the fiber group.</span>
0806     <span class="comment">% Requires a dt structure.</span>
0807     <span class="comment">% westin = fefgGet(fg,'westinshape',dt)</span>
0808     <span class="comment">% westin = fefgGet(fg,'westinshape',eigenvals)</span>
0809     <span class="comment">% westin = fefgGet(fg,'westinshape',dtFileName)</span>
0810     
0811     <span class="keyword">if</span> (~isstruct(varargin{1}) || ischar(varargin{1})) &amp;&amp; ~iscell(varargin{1}) 
0812       <span class="comment">% A dt structue was passed.</span>
0813       eigenvals = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'eigenvals'</span>,varargin{1});
0814     <span class="keyword">else</span>
0815       <span class="comment">% We assume that eigenvals were passed already</span>
0816       eigenvals = varargin{1};
0817     <span class="keyword">end</span>
0818     
0819     <span class="comment">% This was the originial formulation described in:</span>
0820     <span class="comment">% C-F. Westin, S. Peled, H. Gubbjartsson, R. Kikinis, and F.A. Jolesz.</span>
0821     <span class="comment">% Geometrical diffusion measures for MRI from tensor basis analysis.</span>
0822     <span class="comment">% In Proceedings 5th Annual ISMRM, 1997.</span>
0823     nFibers = <a href="fefgGet.html" class="code" title="function val = fefgGet(fg,param,varargin)">fefgGet</a>(fg,<span class="string">'nFibers'</span>);
0824     val     = cell(1,nFibers);
0825 
0826     <span class="comment">% Handling parallel processing</span>
0827     poolwasopen = 1; <span class="comment">% if a matlabpool was open already we do not open nor close one</span>
0828     <span class="keyword">if</span> (matlabpool(<span class="string">'size'</span>) == 0), matlabpool open; poolwasopen=0; <span class="keyword">end</span>
0829     parfor ii = 1:nFibers
0830       [val{ii}.linearity, val{ii}.planarity] = dtiComputeWestinShapes(eigenvals{ii});
0831     <span class="keyword">end</span>
0832     
0833   <span class="keyword">otherwise</span>
0834     error(<span class="string">'Unknown fg parameter: &quot;%s&quot;\n'</span>,param);
0835 <span class="keyword">end</span>
0836 
0837 <span class="keyword">return</span></pre></div>
<hr><address>Generated on Tue 01-Jul-2014 18:45:35 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>