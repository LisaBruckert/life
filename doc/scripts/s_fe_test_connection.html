<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of s_fe_test_connection</title>
  <meta name="keywords" content="s_fe_test_connection">
  <meta name="description" content="% s_fe_test_connection">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">scripts</a> &gt; s_fe_test_connection.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for scripts&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>s_fe_test_connection
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>% s_fe_test_connection</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">% s_fe_test_connection

 Illustrate how to compare the quality of predictions between a connectome
 that has a full complement of fascicles, and one that has a
 specific subset of these fascicles removed.

 In this example, the full connectome is the occipital lobe.     (C1) We
 then remove all the fibers connected to peri-calcarine (optic radiation). (C2) We use
 LiFE to predict the diffusion signal using both C1 and C2. 
 
 In a separate script, we visualize the results.  The basic result is that
 in the peri-calcarine region, removing the fibers connected to optic radiation is a
 bad idea. The RMSE of the prediction increases.  It increases mainly in
 that region.

 In subsequent scripts we both visualize and create graphs summarizing the
 increased prediction error within the key region of interest.

 See also:

 Franco (C) 2012 Stanford VISTA team.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">%% s_fe_test_connection</span>
0002 <span class="comment">%</span>
0003 <span class="comment">% Illustrate how to compare the quality of predictions between a connectome</span>
0004 <span class="comment">% that has a full complement of fascicles, and one that has a</span>
0005 <span class="comment">% specific subset of these fascicles removed.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% In this example, the full connectome is the occipital lobe.     (C1) We</span>
0008 <span class="comment">% then remove all the fibers connected to peri-calcarine (optic radiation). (C2) We use</span>
0009 <span class="comment">% LiFE to predict the diffusion signal using both C1 and C2.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% In a separate script, we visualize the results.  The basic result is that</span>
0012 <span class="comment">% in the peri-calcarine region, removing the fibers connected to optic radiation is a</span>
0013 <span class="comment">% bad idea. The RMSE of the prediction increases.  It increases mainly in</span>
0014 <span class="comment">% that region.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% In subsequent scripts we both visualize and create graphs summarizing the</span>
0017 <span class="comment">% increased prediction error within the key region of interest.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% See also:</span>
0020 <span class="comment">%</span>
0021 <span class="comment">% Franco (C) 2012 Stanford VISTA team.</span>
0022 
0023 <span class="comment">%% Start loading the data</span>
0024 <span class="comment">%</span>
0025 <span class="comment">% At some point, we will put these fe structures into VISTADATA.</span>
0026 <span class="comment">% For now, you can compute them, leave them in the feGet(fe,'savedir'), and load them</span>
0027 <span class="comment">% up for testing.</span>
0028 
0029 recompute_fe = 0; <span class="comment">% if 1, it will load a fibergroup and recompute the fe structure.</span>
0030 
0031 <span class="comment">% Basic directories</span>
0032 <span class="keyword">if</span> ispc,  basePath = fullfile(<span class="string">'\\red.stanford.edu'</span>,<span class="string">'biac2-wandell6'</span>);
0033 <span class="keyword">else</span>      basePath = fullfile(<span class="string">'/biac2'</span>,<span class="string">'wandell6'</span>);
0034 <span class="keyword">end</span>
0035 dataRootPath  = fullfile(basePath,<span class="string">'data'</span>,<span class="string">'frk'</span>,<span class="string">'life_dti'</span>,<span class="string">'FP20120420'</span>);
0036 subfolders    = fullfile(<span class="string">'150dirs_b1000_1'</span>);
0037 baseDir       = fullfile(dataRootPath,subfolders);
0038 saveDir       = fullfile(baseDir,<span class="string">'LiFE'</span>);
0039 dtFile        = fullfile(baseDir,<span class="string">'dt6.mat'</span>);
0040 dwiFile       = fullfile(dataRootPath,<span class="string">'raw'</span>,<span class="string">'0009_01_DWI_2mm150dir_2x_b1000_aligned_trilin.nii.gz'</span>);
0041 fgFileName    = fullfile(saveDir,<span class="string">'fg'</span>,<span class="string">'right_hemisphere_occipital_MRTRIX_FG.mat'</span>);
0042 roisFileNames = {fullfile(saveDir,<span class="string">'rois'</span>,<span class="string">'optic_radiation_AND_roi.mat'</span>), <span class="keyword">...</span>
0043                  fullfile(saveDir,<span class="string">'rois'</span>,<span class="string">'optic_radiation_NOT_roi.mat'</span>), <span class="keyword">...</span>
0044                  fullfile(saveDir,<span class="string">'rois'</span>,<span class="string">'RV1_useme.mat'</span>)};
0045 roiOperations = {<span class="string">'and'</span>,<span class="string">'not'</span>,<span class="string">'and'</span>}; <span class="comment">% Operations to apply with each ROI</span>
0046 
0047 <span class="comment">%% Load the data:</span>
0048 <span class="keyword">if</span> recompute_fe
0049   <span class="comment">% Recompute the fe structure from the original fiber group</span>
0050   <span class="comment">% Initialize the Connectome</span>
0051   fe = feConnectomeInit(dwiFile,dtFile,fgFileName);
0052   
0053   <span class="comment">% Fit the model</span>
0054   fefit  = feFitModel(feGet(fe,<span class="string">'Mfiber'</span>),feGet(fe,<span class="string">'dsig demeaned'</span>),<span class="string">'sgdnn'</span>);
0055   fe     = feSet(fe,<span class="string">'fit'</span>,fefit);
0056   feConnectomeSave(fe)
0057   feConnectomeWrite(fe)
0058   
0059 <span class="keyword">else</span>
0060   <span class="comment">% Load the fe structure from a precomputed file.</span>
0061   disp(<span class="string">'Loading a precomputed fe structure...'</span>)
0062   feFileName = <span class="string">'test_culling_more_right_hemisphere_occipital_MRTRIX_FE.mat'</span>;
0063   <span class="comment">%'20120830T160637-right_hemisphere_occipital_MRTRIX_FE.mat';</span>
0064   load(fullfile(saveDir,feFileName))
0065 <span class="keyword">end</span>
0066 
0067 <span class="comment">%% Restrict the fibers to the optic radiation</span>
0068 all_fibers = true(feGet(fe,<span class="string">'nfibers'</span>),1);
0069 <span class="keyword">for</span> iR = 1:length(roisFileNames)
0070   <span class="comment">% Load the ROI</span>
0071   roi = dtiReadRoi(roisFileNames{iR});
0072   
0073   <span class="comment">% xform the ROI coordinates to IMG space</span>
0074   roi.coords =  mrAnatXformCoords(feGet(fe,<span class="string">'xform acpc2img'</span>),roi.coords);
0075   
0076   <span class="comment">% Keep fibers touching optic radiation</span>
0077   [~,~, this_fibers] = dtiIntersectFibersWithRoi([], {roiOperations{iR}}, [], roi, feGet(fe,<span class="string">'fg img'</span>));
0078  
0079   <span class="comment">% Restrict the fiber indices</span>
0080   all_fibers = and(all_fibers,this_fibers);
0081 <span class="keyword">end</span>
0082 
0083 <span class="comment">% Identify the indices of the fibers to remove.</span>
0084 <span class="comment">% The ones that do not touch V1</span>
0085 fibersToKeep     = find(~all_fibers);
0086 
0087 <span class="comment">% Reduce the connectome. We remove all the fibers touching the ROIs, whcih will keep the optic radiation.</span>
0088 feNOTor = feConnectomeSelectFibers(fe,fibersToKeep);
0089 
0090 <span class="comment">% Now cross-validate the quality fo fit and install the result in the fe structure</span>
0091 fefit   = feFitModel(feGet(feNOTor,<span class="string">'Mfiber'</span>),feGet(feNOTor,<span class="string">'dSig demeaned'</span>),<span class="string">'sgdnn'</span>);
0092 feNOTor = feSet(feNOTor,<span class="string">'fit'</span>,fefit);
0093 <span class="comment">% Save out the fiber group</span>
0094 fgWrite(feGet(feNOTor,<span class="string">'fg acpc'</span>),fullfile(saveDir,<span class="string">'fg'</span>,<span class="string">'NOT_OR_fg'</span>),<span class="string">'mat'</span>);
0095 
0096 
0097 <span class="comment">%% Make an ROI with the voxels of the removed Optic Raadiation fibers</span>
0098 connectome        = feGet(fe,<span class="string">'fg img'</span>);
0099 fgOR             = connectome;
0100 fgOR.fibers      = {}; <span class="comment">% Clear some memory</span>
0101 fgOR.pathwayInfo = {}; <span class="comment">% CLear some memory</span>
0102 OR_fibersToKeep      = find(all_fibers);
0103 <span class="keyword">for</span> ii = 1:length(OR_fibersToKeep)
0104  fgOR.fibers{ii,1} = connectome.fibers{OR_fibersToKeep(ii),1};  
0105 <span class="keyword">end</span>
0106 fgORacpc = dtiXformFiberCoords(fgOR,feGet(fe,<span class="string">'xform img 2acpc'</span>));
0107 fgWrite(fgORacpc,fullfile(saveDir,<span class="string">'fg'</span>,<span class="string">'optic_radiation_fg'</span>),<span class="string">'mat'</span>);
0108 
0109 <span class="comment">% Compute the value along the optic radiation</span>
0110 <span class="comment">% fgORacpcSummary = dtiComputeSuperFiberRepresentation(fgORacpc, [], 100,[]);</span>
0111 
0112 <span class="comment">% Make an ROI and write it to disk</span>
0113 name      = <span class="string">'all-OR-fibers'</span>;
0114 randColor = rand(1,3);
0115 OR_roi    = dtiNewRoi(name,randColor,fefgGet(fgOR,<span class="string">'unique image coords'</span>));
0116 OR_roiAcpc= OR_roi;
0117 OR_roiAcpc.coords = mrAnatXformCoords(feGet(fe,<span class="string">'xform img2acpc'</span>),OR_roiAcpc.coords);
0118 dtiWriteRoi(OR_roiAcpc, fullfile(saveDir,<span class="string">'rois'</span>,<span class="string">'optic_radiation_roi'</span>),<span class="string">'mat'</span>)
0119 
0120 <span class="comment">%% Get the RMSE in the volume of the optic radiation-fibers before and after removing the fibers:</span>
0121 <span class="comment">% With</span>
0122 rmse_with_or    = (feGet(fe,     <span class="string">'vox rmse'</span>,unique(OR_roi.coords,<span class="string">'rows'</span>)));
0123 
0124 <span class="comment">% Save it to file:</span>
0125 niftiName = fullfile(feGet(fe,<span class="string">'savedir'</span>),<span class="string">'rmse_with_or'</span>);
0126 rmse_w_map = feValues2volume(rmse_with_or,unique(OR_roi.coords,<span class="string">'rows'</span>),feGet(fe,<span class="string">'map size'</span>));
0127 nii         = niftiCreate(<span class="string">'data'</span>,rmse_w_map,<span class="keyword">...</span>
0128                   <span class="string">'qto_xyz'</span>,feGet(fe,<span class="string">'xform img 2 acpc'</span>),<span class="keyword">...</span>
0129                   <span class="string">'fname'</span>,niftiName);
0130 niftiWrite(nii);
0131 
0132 <span class="comment">% Without</span>
0133 rmse_without_or = (feGet(feNOTor,<span class="string">'vox rmse'</span>,unique(OR_roi.coords,<span class="string">'rows'</span>)));
0134 
0135 <span class="comment">% Save it to file</span>
0136 niftiName   = fullfile(feGet(fe,<span class="string">'savedir'</span>),<span class="string">'rmse_without_or'</span>);
0137 rmse_wo_map = feValues2volume(rmse_without_or,unique(OR_roi.coords,<span class="string">'rows'</span>),feGet(fe,<span class="string">'map size'</span>));
0138 nii         = niftiCreate(<span class="string">'data'</span>,rmse_wo_map,<span class="keyword">...</span>
0139                   <span class="string">'qto_xyz'</span>,feGet(fe,<span class="string">'xform img 2 acpc'</span>),<span class="keyword">...</span>
0140                   <span class="string">'fname'</span>,niftiName);
0141 niftiWrite(nii);
0142 
0143 <span class="comment">%% Get the RMSE in the whole connectome volume before and after removing the fibers:</span>
0144 <span class="comment">% With</span>
0145 roi          = feGet(fe,<span class="string">'roi'</span>);
0146 rmse_with_or = (feGet(fe, <span class="string">'vox rmse'</span>,unique(roi.coords,<span class="string">'rows'</span>)));
0147 
0148 <span class="comment">% data rmse file</span>
0149 rmseFileName = <span class="string">'/biac2/wandell6/data/arokem/ModelFits/FP20120420/raw/signal_rmse_b1000.nii.gz'</span>;
0150 
0151 
0152 <span class="comment">% Save it to file:</span>
0153 [sz]  = dwiGet(dwiFile,<span class="string">'volume size'</span>);
0154 niftiName  = fullfile(feGet(fe,<span class="string">'savedir'</span>),<span class="string">'rmse_with_or_wholebrain'</span>);
0155 rmse_w_map = feValues2volume(rmse_with_or,unique(roi.coords,<span class="string">'rows'</span>),sz(1:3));
0156 nii        = niftiCreate(<span class="string">'data'</span>,rmse_w_map,<span class="keyword">...</span>
0157                          <span class="string">'qto_xyz'</span>,feGet(fe,<span class="string">'xform img 2 acpc'</span>),<span class="keyword">...</span>
0158                          <span class="string">'fname'</span>,niftiName);
0159 niftiWrite(nii);
0160 
0161 <span class="comment">% Without</span>
0162 rmse_without_or = (feGet(feNOTor, <span class="string">'vox rmse'</span>,unique(roi.coords,<span class="string">'rows'</span>)));
0163 
0164 <span class="comment">% Save it to file</span>
0165 niftiName   = fullfile(feGet(fe,<span class="string">'savedir'</span>),<span class="string">'rmse_without_or_wholebrain'</span>);
0166 rmse_wo_map = feValues2volume(rmse_without_or,unique(roi.coords,<span class="string">'rows'</span>),sz(1:3));
0167 nii         = niftiCreate(<span class="string">'data'</span>,rmse_wo_map,<span class="keyword">...</span>
0168                   <span class="string">'qto_xyz'</span>,feGet(fe,<span class="string">'xform img 2 acpc'</span>),<span class="keyword">...</span>
0169                   <span class="string">'fname'</span>,niftiName);
0170 niftiWrite(nii);
0171 
0172 
0173 <span class="comment">%% make a scatter plot of the loss in explained variance.</span>
0174 mrvNewGraphWin(<span class="string">'Increase in RMSE without optic radiation fibers'</span>)
0175 plot(rmse_with_or,rmse_without_or,<span class="string">'ro'</span>,<span class="string">'MarkerFaceColor'</span>,<span class="string">'r'</span>)
0176 axlim = get(gca,<span class="string">'xLim'</span>);axis square;set(gca,<span class="string">'yLim'</span>,axlim);
0177 hold on, 
0178 plot([axlim(1);axlim(2)], [axlim(1); axlim(2)],<span class="string">'k-'</span>)
0179 ylabel(<span class="string">'RMSE without optic radiation fibers'</span>);xlabel(<span class="string">'RMSE with optic radiation fibers'</span>)
0180 
0181 <span class="comment">%% make a histogram RMSE</span>
0182 mrvNewGraphWin(<span class="string">'RMSE with and without optic radiation fibers'</span>)
0183 [y,x] = hist(rmse_without_or,200);bar(x,y,<span class="string">'r'</span>,<span class="string">'BarWidth'</span>,0.65)
0184 hold on
0185 [y,x] = hist(rmse_with_or,200);bar(x,y,<span class="string">'k'</span>,<span class="string">'BarWidth'</span>,0.35)
0186 ylabel(<span class="string">'Occurrences'</span>);xlabel(<span class="string">'RMSE'</span>);
0187 legend({<span class="string">'With optic radiation fibers'</span>,<span class="string">'Without optic radiation fibers'</span>})
0188 
0189 keyboard
0190 <span class="comment">%% End</span></pre></div>
<hr><address>Generated on Tue 01-Jul-2014 11:25:56 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>